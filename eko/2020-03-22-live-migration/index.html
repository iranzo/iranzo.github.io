<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Live Migration in KubeVirt | Pablo Iranzo Gómez blog</title>
<meta name=keywords content="kubevirt,kubernetes,virtual machine,VM,Live Migration,node drain"><meta name=description content="KubeVirt leverages Live Migration to support workloads to keep running while nodes can be moved to maintenance, etc Check what is needed to get it working and how it works."><meta name=author content="Pablo Iranzo Gómez"><link rel=canonical href=https://iranzo.io/eko/2020-03-22-live-migration/><meta name=google-site-verification content="Bk4Z5ucHLyPXqlZlj5LzANpYBBSvxqBW4E8i-Kwf-bQ"><meta name=yandex-verification content="993ede96cdfbee95"><link crossorigin=anonymous href=../../assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://iranzo.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://iranzo.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://iranzo.io/favicon-32x32.png><link rel=apple-touch-icon href=https://iranzo.io/apple-touch-icon.png><link rel=mask-icon href=https://iranzo.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://iranzo.io/eko/2020-03-22-live-migration/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZL9P943TP1"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-ZL9P943TP1")}</script><meta property="og:url" content="https://iranzo.io/eko/2020-03-22-live-migration/"><meta property="og:site_name" content="Pablo Iranzo Gómez blog"><meta property="og:title" content="Live Migration in KubeVirt"><meta property="og:description" content="KubeVirt leverages Live Migration to support workloads to keep running while nodes can be moved to maintenance, etc Check what is needed to get it working and how it works."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="eko"><meta property="article:published_time" content="2020-03-22T00:00:00+02:00"><meta property="article:modified_time" content="2023-08-25T09:48:47+00:00"><meta property="article:tag" content="Kubevirt"><meta property="article:tag" content="Kubernetes"><meta property="article:tag" content="Virtual Machine"><meta property="article:tag" content="VM"><meta property="article:tag" content="Live Migration"><meta property="article:tag" content="Node Drain"><meta property="og:image" content="https://iranzo.io/mugshot.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://iranzo.io/mugshot.png"><meta name=twitter:title content="Live Migration in KubeVirt"><meta name=twitter:description content="KubeVirt leverages Live Migration to support workloads to keep running while nodes can be moved to maintenance, etc Check what is needed to get it working and how it works."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Ekoes","item":"https://iranzo.io/eko/"},{"@type":"ListItem","position":2,"name":"Live Migration in KubeVirt","item":"https://iranzo.io/eko/2020-03-22-live-migration/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Live Migration in KubeVirt","name":"Live Migration in KubeVirt","description":"KubeVirt leverages Live Migration to support workloads to keep running while nodes can be moved to maintenance, etc Check what is needed to get it working and how it works.","keywords":["kubevirt","kubernetes","virtual machine","VM","Live Migration","node drain"],"articleBody":"This article was published originally at https://kubevirt.io/2020/Live-migration.html\nIntroduction This blog post will be explaining on KubeVirt’s ability to perform live migration of virtual machines.\nLive Migration is a process during which a running Virtual Machine Instance moves to another compute node while the guest workload continues to run and remain accessible.\nThe concept of live migration is already well-known among virtualization platforms and enables administrators to keep user workloads running while the servers can be moved to maintenance for any reason that you might think of like:\nHardware maintenance (physical, firmware upgrades, etc) Power management, by moving workloads to a lower number of hypervisors during off-peak hours etc KubeVirt also includes support for virtual machine migration within Kubernetes when enabled.\nKeep reading to learn how!\nEnabling Live Migration To enable live migration we need to enable the feature-gate for it by adding LiveMigration to the key:\napiVersion: v1 kind: ConfigMap metadata: name: kubevirt-config namespace: kubevirt labels: kubevirt.io: \"\" data: feature-gates: \"LiveMigration\" A current kubevirt-config can be edited to append “LiveMigration” to an existing configuration:\nkubectl edit configmap kubevirt-config -n kubevirt data: feature-gates: \"DataVolumes,LiveMigration\" Configuring Live Migration If we want to alter the defaults for Live-Migration, we can further edit the kubevirt-config like:\napiVersion: v1 kind: ConfigMap metadata: name: kubevirt-config namespace: kubevirt labels: kubevirt.io: \"\" data: feature-gates: \"LiveMigration\" migrations: |- parallelMigrationsPerCluster: 5 parallelOutboundMigrationsPerNode: 2 bandwidthPerMigration: 64Mi completionTimeoutPerGiB: 800 progressTimeout: 150 Parameters are explained in the below table (check the documentation for more details):\nParameter Default value Description parallelMigrationsPerCluster 5 How many migrations might happen at the same time parallelOutboundMigrationsPerNode 2 How many outbound migrations for a particular node bandwidthPerMigration 64Mi MiB/s to have the migration limited to, in order to not affect other systems completionTimeoutPerGiB 800 Time for a GiB of data to wait to be completed before aborting the migration. progressTimeout 150 Time to wait for Live Migration to progress in transferring data Performing the Live Migration Error\nVirtual Machines using PVC must have a RWX access mode to be Live-Migrated Additionally, pod network binding of bridge interface is not allowed Live migration is initiated by posting an object VirtualMachineInstanceMigration to the cluster, indicating the VM name to migrate, like in the following example:\napiVersion: kubevirt.io/v1alpha3 kind: VirtualMachineInstanceMigration metadata: name: migration-job spec: vmiName: vmi-fedora This will trigger the process for the VM.\nNote\nWhen a VM is started, a calculation has been already performed indicating if the VM is live-migratable or not. This information is stored in the VMI.status.conditions. Currently, most of the calculation is based on the Access Mode for the VMI volumes but can be based on multiple parameters. For example:\nStatus: Conditions: Status: True Type: LiveMigratable Migration Method: BlockMigration If the VM is Live-Migratable, the request will submit successfully. The status change will be reported under VMI.status. Once live migration is complete, a status of Completed or Failed will be indicated.\nImportant\nThe Migration Method field can contain:\nBlockMigration : meaning that the disk data is being copied from source to destination LiveMigration: meaning that only the memory is copied from source to destination VMs with block devices located on shared storage backends like the ones provided by Rook that provide PVCs with ReadWriteMany access have the option to live-migrate only memory contents instead of having to also migrate the block devices.\nCancelling a Live Migration If we want to abort the Live Migration, ‘Kubernetes-Style’, we’ll just delete the object we created for triggering it.\nIn this case, the VM status for migration will report some additional information:\nMigration State: Abort Requested: true Abort Status: Succeeded Completed: true End Timestamp: 2019-03-29T04:02:49Z Failed: true Migration Config: Completion Timeout Per GiB: 800 Progress Timeout: 150 Migration UID: 57a693d6-51d7-11e9-b370-525500d15501 Source Node: node02 Start Timestamp: 2019-03-29T04:02:47Z Target Direct Migration Node Ports: 39445: 0 43345: 49152 44222: 49153 Target Node: node01 Target Node Address: 10.128.0.46 Target Node Domain Detected: true Target Pod: virt-launcher-testvmimcbjgw6zrzcmp8wpddvztvzm7x2k6cjbdgktwv8tkq Note that there are some additional fields that indicate that Abort Requested happened and in the above example that it has Succeded, in this case, the original fields for migration will report as Completed (because there’s no running migration) and Failed set to true.\nWhat can go wrong? Live-migration is a complex process that requires transferring data from one ‘VM’ in one node to another ‘VM’ into another one, this requires that the activity of the VM being live-migrated to be compatible with the network configuration and throughput so that all the data can be migrated faster than the data is changed at the original VM, this is usually referred to as converging.\nSome values can be adjusted (check the table for settings that can be tuned), to allow it to succeed but as a trade-off:\nIncreasing the number of VMs that can migrate at once, will reduce the available bandwidth. Increasing the bandwidth could affect applications running on that node (origin and target). Storage migration (check the Info note in the Performing the Live Migration section on the differences) might also consume bandwidth and resources. Node Eviction Sometimes, a node requires to be put on maintenance and it includes workloads on it, either containers or, in KubeVirt’s case, VM’s.\nIt is possible to use selectors, for example, move all the virtual machines to another node via kubectl drain , for example, evicting all KubeVirt VM’s from a node can be done via:\nkubectl drain --delete-local-data --ignore-daemonsets=true --force --pod-selector=kubevirt.io=virt-launcher Reenabling node after eviction\nOnce the node has been tainted for eviction, we can use kubectl uncordon to make it schedulable again.\nAccording to documentation, --delete-local-data, --ignore-daemonsets and --force are required because:\nPods using emptyDir can be deleted because the data is ephemeral. VMI will have DaemonSets via virt-handler so it’s safe to proceed. VMIs are not owned by a ReplicaSet or DaemonSet, so kubectl can’t guarantee that those are restarted. KubeVirt has its own controllers for it managing VMI, so kubectl shouldn’t bother about it. If we omit the --pod-selector, we’ll force eviction of all Pods and VM’s from a node.\nImportant\nIn order to have VMIs using LiveMigration for eviction, we have to add a specific spec in the VMI YAML, so that when the node is tainted with kubevirt.io/drain:NoSchedule is added to a node.\nspec: evictionStrategy: LiveMigrate From that point, when kubectl taint nodes kubevirt.io/drain=draining:NoSchedule is executed, the migrations will start.\nConclusion As a briefing on the above data:\nLiveMigrate needs to be enabled on KubeVirt as a feature gate. LiveMigrate will add status to the VMI object indicating if it’s a candidate or not and if so, which mode to use (Block or Live) Based on the storage backend and other conditions, it will enable LiveMigration or just BlockMigration. References Live Migration Node Drain/Eviction Rook Enjoy! (and if you do, you can Buy Me a Coffee ) ","wordCount":"1125","inLanguage":"en","image":"https://iranzo.io/mugshot.png","datePublished":"2020-03-22T00:00:00+02:00","dateModified":"2023-08-25T09:48:47.749Z","author":{"@type":"Person","name":"Pablo Iranzo Gómez"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://iranzo.io/eko/2020-03-22-live-migration/"},"publisher":{"@type":"Organization","name":"Pablo Iranzo Gómez blog","logo":{"@type":"ImageObject","url":"https://iranzo.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://iranzo.io/ accesskey=h title="Home (Alt + H)"><img src=https://iranzo.io/apple-icon-152x152.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://iranzo.io/es/ title=Spanish aria-label=Spanish>Es</a></li></ul></div></div><ul id=menu><li><a href=https://iranzo.io/ title=🏠Home><span>🏠Home</span></a></li><li><a href=https://iranzo.io/about/ title=🗒️About><span>🗒️About</span></a></li><li><a href=https://iranzo.io/redken_bot/ title=🐘redken_bot><span>🐘redken_bot</span></a></li><li><a href=https://iranzo.io/projects/ title=📐Projects><span>📐Projects</span></a></li><li><a href=https://iranzo.io/archives/ title="🗄️ Archives"><span>🗄️ Archives</span></a></li><li><a href=https://iranzo.io/categories/ title=🗺️Categories><span>🗺️Categories</span></a></li><li><a href=https://iranzo.io/tags/ title=🏷️Tags><span>🏷️Tags</span></a></li><li><a href=https://iranzo.io/search title="🔎Search (Alt + /)" accesskey=/><span>🔎Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://iranzo.io/>Home</a>&nbsp;»&nbsp;<a href=https://iranzo.io/eko/>Ekoes</a></div><h1 class="post-title entry-hint-parent">Live Migration in KubeVirt</h1><div class=post-description>KubeVirt leverages Live Migration to support workloads to keep running while nodes can be moved to maintenance, etc Check what is needed to get it working and how it works.</div><div class=post-meta><span title='2020-03-22 00:00:00 +0200 +0200'>March 22, 2020</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;Pablo Iranzo Gómez</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#introduction aria-label=Introduction>Introduction</a></li><li><a href=#enabling-live-migration aria-label="Enabling Live Migration">Enabling Live Migration</a></li><li><a href=#configuring-live-migration aria-label="Configuring Live Migration">Configuring Live Migration</a></li><li><a href=#performing-the-live-migration aria-label="Performing the Live Migration">Performing the Live Migration</a><ul><li><a href=#cancelling-a-live-migration aria-label="Cancelling a Live Migration">Cancelling a Live Migration</a></li></ul></li><li><a href=#what-can-go-wrong aria-label="What can go wrong?">What can go wrong?</a></li><li><a href=#node-eviction aria-label="Node Eviction">Node Eviction</a></li><li><a href=#conclusion aria-label=Conclusion>Conclusion</a></li><li><a href=#references aria-label=References>References</a></li></ul></div></details></div><div class=post-content><p>This article was published originally at <a href=https://kubevirt.io/2020/Live-migration.html>https://kubevirt.io/2020/Live-migration.html</a></p><h2 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h2><p>This blog post will be explaining on KubeVirt&rsquo;s ability to perform live migration of virtual machines.</p><blockquote><p>Live Migration is a process during which a running Virtual Machine Instance moves to another compute node while the guest workload continues to run and remain accessible.</p></blockquote><p>The concept of live migration is already well-known among virtualization platforms and enables administrators to keep user workloads running while the servers can be moved to maintenance for any reason that you might think of like:</p><ul><li>Hardware maintenance (physical, firmware upgrades, etc)</li><li>Power management, by moving workloads to a lower number of hypervisors during off-peak hours</li><li>etc</li></ul><p>KubeVirt also includes support for virtual machine migration within Kubernetes when enabled.</p><p>Keep reading to learn how!</p><h2 id=enabling-live-migration>Enabling Live Migration<a hidden class=anchor aria-hidden=true href=#enabling-live-migration>#</a></h2><p>To enable live migration we need to enable the <code>feature-gate</code> for it by adding <code>LiveMigration</code> to the key:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ConfigMap</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>kubevirt-config</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>kubevirt</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>kubevirt.io</span>: <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>data</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>feature-gates</span>: <span style=color:#e6db74>&#34;LiveMigration&#34;</span>
</span></span></code></pre></div><p>A current <code>kubevirt-config</code> can be edited to append &ldquo;<code>LiveMigration</code>&rdquo; to an existing configuration:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl edit configmap kubevirt-config -n kubevirt
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>data</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>feature-gates</span>: <span style=color:#e6db74>&#34;DataVolumes,LiveMigration&#34;</span>
</span></span></code></pre></div><h2 id=configuring-live-migration>Configuring Live Migration<a hidden class=anchor aria-hidden=true href=#configuring-live-migration>#</a></h2><p>If we want to alter the defaults for Live-Migration, we can further edit the <code>kubevirt-config</code> like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ConfigMap</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>kubevirt-config</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>kubevirt</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>kubevirt.io</span>: <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>data</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>feature-gates</span>: <span style=color:#e6db74>&#34;LiveMigration&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>migrations</span>: |-<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  parallelMigrationsPerCluster: 5
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  parallelOutboundMigrationsPerNode: 2
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  bandwidthPerMigration: 64Mi
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  completionTimeoutPerGiB: 800
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  progressTimeout: 150</span>
</span></span></code></pre></div><p>Parameters are explained in the below table (check the documentation for more details):</p><table><thead><tr><th style=text-align:left>Parameter</th><th style=text-align:center>Default value</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><code>parallelMigrationsPerCluster</code></td><td style=text-align:center>5</td><td style=text-align:left>How many migrations might happen at the same time</td></tr><tr><td style=text-align:left><code>parallelOutboundMigrationsPerNode</code></td><td style=text-align:center>2</td><td style=text-align:left>How many outbound migrations for a particular node</td></tr><tr><td style=text-align:left><code>bandwidthPerMigration</code></td><td style=text-align:center>64Mi</td><td style=text-align:left>MiB/s to have the migration limited to, in order to not affect other systems</td></tr><tr><td style=text-align:left><code>completionTimeoutPerGiB</code></td><td style=text-align:center>800</td><td style=text-align:left>Time for a GiB of data to wait to be completed before aborting the migration.</td></tr><tr><td style=text-align:left><code>progressTimeout</code></td><td style=text-align:center>150</td><td style=text-align:left>Time to wait for Live Migration to progress in transferring data</td></tr></tbody></table><h2 id=performing-the-live-migration>Performing the Live Migration<a hidden class=anchor aria-hidden=true href=#performing-the-live-migration>#</a></h2><p><div class="admonition error"><p class=admonition-title>Error</p><p class=admonition><ol><li>Virtual Machines using PVC must have a <code>RWX</code> access mode to be Live-Migrated</li><li>Additionally, pod network binding of bridge interface is not allowed</li></ol></p></div>Live migration is initiated by posting an object <code>VirtualMachineInstanceMigration</code> to the cluster, indicating the VM name to migrate, like in the following example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>kubevirt.io/v1alpha3</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>VirtualMachineInstanceMigration</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>migration-job</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>vmiName</span>: <span style=color:#ae81ff>vmi-fedora</span>
</span></span></code></pre></div><p>This will trigger the process for the VM.</p><p><div class="admonition note"><p class=admonition-title>Note</p><p class=admonition><p>When a VM is started, a calculation has been already performed indicating if the VM is live-migratable or not. This information is stored in the <code>VMI.status.conditions</code>. Currently, most of the calculation is based on the <code>Access Mode</code> for the VMI volumes but can be based on multiple parameters. For example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>Status</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>Conditions</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>Status</span>: <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>Type</span>: <span style=color:#ae81ff>LiveMigratable</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>Migration Method</span>: <span style=color:#ae81ff>BlockMigration</span>
</span></span></code></pre></div></p></div>If the VM is Live-Migratable, the request will submit successfully. The status change will be reported under <code>VMI.status</code>. Once live migration is complete, a status of <code>Completed</code> or <code>Failed</code> will be indicated.</p><div class="admonition important"><p class=admonition-title>Important</p><p class=admonition><p>The <code>Migration Method</code> field can contain:</p><ul><li><code>BlockMigration</code> : meaning that the disk data is being copied from source to destination</li><li><code>LiveMigration</code>: meaning that only the memory is copied from source to destination</li></ul><p>VMs with block devices located on shared storage backends like the ones provided by <a href=https://rook.io/>Rook</a> that provide PVCs with ReadWriteMany access have the option to live-migrate only memory contents instead of having to also migrate the block devices.</p></p></div><h3 id=cancelling-a-live-migration>Cancelling a Live Migration<a hidden class=anchor aria-hidden=true href=#cancelling-a-live-migration>#</a></h3><p>If we want to abort the Live Migration, &lsquo;Kubernetes-Style&rsquo;, we&rsquo;ll just delete the object we created for triggering it.</p><p>In this case, the VM status for migration will report some additional information:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>Migration State</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>Abort Requested</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>Abort Status</span>: <span style=color:#ae81ff>Succeeded</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>Completed</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>End Timestamp</span>: <span style=color:#e6db74>2019-03-29T04:02:49Z</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>Failed</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>Migration Config</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>Completion Timeout Per GiB</span>: <span style=color:#ae81ff>800</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>Progress Timeout</span>: <span style=color:#ae81ff>150</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>Migration UID</span>: <span style=color:#ae81ff>57a693d6-51d7-11e9-b370-525500d15501</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>Source Node</span>: <span style=color:#ae81ff>node02</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>Start Timestamp</span>: <span style=color:#e6db74>2019-03-29T04:02:47Z</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>Target Direct Migration Node Ports</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>39445</span>: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>43345</span>: <span style=color:#ae81ff>49152</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>44222</span>: <span style=color:#ae81ff>49153</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>Target Node</span>: <span style=color:#ae81ff>node01</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>Target Node Address</span>: <span style=color:#ae81ff>10.128.0.46</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>Target Node Domain Detected</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>Target Pod</span>: <span style=color:#ae81ff>virt-launcher-testvmimcbjgw6zrzcmp8wpddvztvzm7x2k6cjbdgktwv8tkq</span>
</span></span></code></pre></div><p>Note that there are some additional fields that indicate that <code>Abort Requested</code> happened and in the above example that it has <code>Succeded</code>, in this case, the original fields for migration will report as <code>Completed</code> (because there&rsquo;s no running migration) and <code>Failed</code> set to true.</p><h2 id=what-can-go-wrong>What can go wrong?<a hidden class=anchor aria-hidden=true href=#what-can-go-wrong>#</a></h2><p>Live-migration is a complex process that requires transferring data from one &lsquo;VM&rsquo; in one node to another &lsquo;VM&rsquo; into another one, this requires that the activity of the VM being live-migrated to be compatible with the network configuration and throughput so that all the data can be migrated <em>faster</em> than the data is changed at the original VM, this is usually referred to as <em>converging</em>.</p><p>Some values can be adjusted (check the <a href=../../eko/2020-03-22-live-migration/#configuring-live-migration>table</a> for settings that can be tuned), to allow it to succeed but as a trade-off:</p><ul><li>Increasing the number of VMs that can migrate at once, will reduce the available bandwidth.</li><li>Increasing the bandwidth could affect applications running on that node (origin and target).</li><li>Storage migration (check the <code>Info</code> note in the <a href=../../eko/2020-03-22-live-migration/#performing-the-live-migration>Performing the Live Migration </a>section on the differences) might also consume bandwidth and resources.</li></ul><h2 id=node-eviction>Node Eviction<a hidden class=anchor aria-hidden=true href=#node-eviction>#</a></h2><p>Sometimes, a node requires to be put on maintenance and it includes workloads on it, either containers or, in KubeVirt&rsquo;s case, VM&rsquo;s.</p><p>It is possible to use <strong>selectors</strong>, for example, move all the virtual machines to another node via <code>kubectl drain &lt;nodename></code>, for example, evicting all KubeVirt VM&rsquo;s from a node can be done via:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl drain &lt;node name&gt; --delete-local-data --ignore-daemonsets<span style=color:#f92672>=</span>true --force --pod-selector<span style=color:#f92672>=</span>kubevirt.io<span style=color:#f92672>=</span>virt-launcher
</span></span></code></pre></div><div class="admonition warning"><p class=admonition-title>Reenabling node after eviction</p><p class=admonition>Once the node has been tainted for eviction, we can use <code>kubectl uncordon &lt;nodename></code> to make it schedulable again.</p></div><p>According to documentation, <code>--delete-local-data</code>, <code>--ignore-daemonsets</code> and <code>--force</code> are required because:</p><ul><li>Pods using <code>emptyDir</code> can be deleted because the data is ephemeral.</li><li>VMI will have <code>DaemonSets</code> via <code>virt-handler</code> so it&rsquo;s safe to proceed.</li><li>VMIs are not owned by a <code>ReplicaSet</code> or <code>DaemonSet</code>, so kubectl can&rsquo;t guarantee that those are restarted. KubeVirt has its own controllers for it managing VMI, so kubectl shouldn&rsquo;t bother about it.</li></ul><p>If we omit the <code>--pod-selector</code>, we&rsquo;ll force eviction of all Pods and VM&rsquo;s from a node.</p><div class="admonition important"><p class=admonition-title>Important</p><p class=admonition><p>In order to have VMIs using <code>LiveMigration</code> for eviction, we have to add a specific spec in the VMI YAML, so that when the node is tainted with <code>kubevirt.io/drain:NoSchedule</code> is added to a node.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>evictionStrategy</span>: <span style=color:#ae81ff>LiveMigrate</span>
</span></span></code></pre></div><p>From that point, when <code>kubectl taint nodes &lt;foo> kubevirt.io/drain=draining:NoSchedule</code> is executed, the migrations will start.</p></p></div><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>As a briefing on the above data:</p><ul><li><code>LiveMigrate</code> needs to be enabled on KubeVirt as a feature gate.</li><li><code>LiveMigrate</code> will add status to the VMI object indicating if it&rsquo;s a candidate or not and if so, which mode to use (Block or Live)<ul><li>Based on the storage backend and other conditions, it will enable <code>LiveMigration</code> or just <code>BlockMigration</code>.</li></ul></li></ul><h2 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h2><ul><li><a href=https://kubevirt.io/user-guide/operations/live_migration/>Live Migration</a></li><li><a href=https://kubevirt.io/user-guide/operations/node_maintenance/#evict-all-vms-from-a-node>Node Drain/Eviction</a></li><li><a href=https://rook.io/>Rook</a><p>Enjoy! (and if you do, you can
<a href=https://ko-fi.com/I2I4KDA0V target=_blank><img src=https://storage.ko-fi.com/cdn/brandasset/kofi_s_logo_nolabel.png height=36 style=border:0;height:36px;vertical-align:middle;display:inline-block border=0>
</img>
Buy Me a Coffee
</a>)</p></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://iranzo.io/tags/kubevirt/>Kubevirt</a></li><li><a href=https://iranzo.io/tags/kubernetes/>Kubernetes</a></li><li><a href=https://iranzo.io/tags/virtual-machine/>Virtual Machine</a></li><li><a href=https://iranzo.io/tags/vm/>VM</a></li><li><a href=https://iranzo.io/tags/live-migration/>Live Migration</a></li><li><a href=https://iranzo.io/tags/node-drain/>Node Drain</a></li></ul><nav class=paginav><a class=prev href=https://iranzo.io/blog/2020/03/22/lego-creator-fiat-500-10271/><span class=title>« Prev</span><br><span>Lego Creator Fiat 500 10271</span>
</a><a class=next href=https://iranzo.io/blog/2020/03/12/yaspeller-hook-for-pre-commit/><span class=title>Next »</span><br><span>Yaspeller hook for pre-commit</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Live Migration in KubeVirt on x" href="https://x.com/intent/tweet/?text=Live%20Migration%20in%20KubeVirt&amp;url=https%3a%2f%2firanzo.io%2feko%2f2020-03-22-live-migration%2f&amp;hashtags=kubevirt%2ckubernetes%2cvirtualmachine%2cVM%2cLiveMigration%2cnodedrain"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Live Migration in KubeVirt on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2firanzo.io%2feko%2f2020-03-22-live-migration%2f&amp;title=Live%20Migration%20in%20KubeVirt&amp;summary=Live%20Migration%20in%20KubeVirt&amp;source=https%3a%2f%2firanzo.io%2feko%2f2020-03-22-live-migration%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Live Migration in KubeVirt on reddit" href="https://reddit.com/submit?url=https%3a%2f%2firanzo.io%2feko%2f2020-03-22-live-migration%2f&title=Live%20Migration%20in%20KubeVirt"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Live Migration in KubeVirt on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2firanzo.io%2feko%2f2020-03-22-live-migration%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Live Migration in KubeVirt on whatsapp" href="https://api.whatsapp.com/send?text=Live%20Migration%20in%20KubeVirt%20-%20https%3a%2f%2firanzo.io%2feko%2f2020-03-22-live-migration%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Live Migration in KubeVirt on telegram" href="https://telegram.me/share/url?text=Live%20Migration%20in%20KubeVirt&amp;url=https%3a%2f%2firanzo.io%2feko%2f2020-03-22-live-migration%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Live Migration in KubeVirt on ycombinator" href="https://news.ycombinator.com/submitlink?t=Live%20Migration%20in%20KubeVirt&u=https%3a%2f%2firanzo.io%2feko%2f2020-03-22-live-migration%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://iranzo.io/>Pablo Iranzo Gómez blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><center><small>This blog is a participant in the Amazon Associate Program, an affiliate advertising program designed to provide a means for sites to earn advertising fees by advertising and linking to Amazon.</small></center><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>