<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Ansible setup for VPN using WireGuard | Pablo Iranzo G√≥mez blog</title><meta name=keywords content="VPN,WireGuard,Ansible,Linux,automation"><meta name=description content="Learn on how to setup a VPN using WireGuard using Ansible"><meta name=author content="Pablo Iranzo G√≥mez"><link rel=canonical href=https://iranzo.io/blog/2022/03/17/ansible-setup-for-vpn-using-wireguard/><meta name=google-site-verification content="Bk4Z5ucHLyPXqlZlj5LzANpYBBSvxqBW4E8i-Kwf-bQ"><meta name=yandex-verification content="993ede96cdfbee95"><link crossorigin=anonymous href=../../../../../assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://iranzo.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://iranzo.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://iranzo.io/favicon-32x32.png><link rel=apple-touch-icon href=https://iranzo.io/apple-touch-icon.png><link rel=mask-icon href=https://iranzo.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://iranzo.io/blog/2022/03/17/ansible-setup-for-vpn-using-wireguard/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZL9P943TP1"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-ZL9P943TP1")}</script><meta property="og:url" content="https://iranzo.io/blog/2022/03/17/ansible-setup-for-vpn-using-wireguard/"><meta property="og:site_name" content="Pablo Iranzo G√≥mez blog"><meta property="og:title" content="Ansible setup for VPN using WireGuard"><meta property="og:description" content="Learn on how to setup a VPN using WireGuard using Ansible"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2022-03-17T20:32:50+00:00"><meta property="article:modified_time" content="2023-08-25T09:45:44+00:00"><meta property="article:tag" content="VPN"><meta property="article:tag" content="WireGuard"><meta property="article:tag" content="Ansible"><meta property="article:tag" content="Linux"><meta property="article:tag" content="Automation"><meta property="og:image" content="https://iranzo.io/mugshot.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://iranzo.io/mugshot.png"><meta name=twitter:title content="Ansible setup for VPN using WireGuard"><meta name=twitter:description content="Learn on how to setup a VPN using WireGuard using Ansible"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blogs","item":"https://iranzo.io/blog/"},{"@type":"ListItem","position":2,"name":"Ansible setup for VPN using WireGuard","item":"https://iranzo.io/blog/2022/03/17/ansible-setup-for-vpn-using-wireguard/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Ansible setup for VPN using WireGuard","name":"Ansible setup for VPN using WireGuard","description":"Learn on how to setup a VPN using WireGuard using Ansible","keywords":["VPN","WireGuard","Ansible","Linux","automation"],"articleBody":"Setting up WireGuard is not a difficult process but I wanted to automate it among hosts by using a simple playbook that can be executed against the hosts and get it configured and deployed in a simple way.\nI also wanted to require the minimum possible number of values in the inventory, so tried to automate lot of the information required, leaving in the end only some required values:\nwireguard: True wgrole: 'master' or 'something else' wgport: port number to use The first step was to create the private and public key once the wireguard package is installed.\nThis was more or less easy, just run and store the output in the folder for WireGuard.\n# Create private key wg genkey | tee privatekey # Create public key wg pubkey \u003c privatekey | tee publickey Later, I could set via Ansible‚Äôs set_fact:\n- name: Set WireGuard keys set_fact: wgprivatekey: \"{{ lookup('file', 'privatekey') }}\" wgpublickey: \"{{ lookup('file', 'publickey') }}\" But I got to the first problem‚Ä¶ the facts are set by the host running the playbook, and for setting master/client connection I need to use the master‚Äôs public key available on the client, and the client‚Äôs public key on the master.\nAs the fact was setup at execution, other hosts couldn‚Äôt check them via hostvars‚Ä¶\nTo solve this issue I went by creating a custom fact that is copied over the hosts, and that causes the host to refresh if something has been copied, this made the fact available in the execution:\nFacts for private key:\n#!/bin/bash echo \"{\\\"wgprivkey\\\" : \\\"$(cat /etc/wireguard/privatekey)\\\"}\" Fact for public key:\n#!/bin/bash echo \"{\\\"wgpubkey\\\" : \\\"$(cat /etc/wireguard/publickey)\\\"}\" Note that both, provide output in a JSON compatible format.\nWe now need to copy the facts to the hosts and refresh the data if needed:\n- name: Create directory for ansible custom facts file: state: directory recurse: yes path: /etc/ansible/facts.d register: facts_dir_created - name: Copy custom facts copy: src: \"{{ item }}\" dest: /etc/ansible/facts.d/ owner: root group: root mode: 0755 with_fileglob: - \"facts/*.fact\" register: facts_copied - name: \"Re-run setup to use custom facts\" setup: ~ when: facts_copied.changed Now‚Ä¶ all hosts have the facts for private and public key so that can be used‚Ä¶ but we need to actually create WireGuard configuration file for it‚Ä¶ but wait‚Ä¶ we need to know which host is the master that will receive all connections from the clients.\nSo, let‚Äôs detect the master by the wgrole value:\n- name: Set wireguard master server host set_fact: wgmaster: \"{{ item }}\" with_items: \"{{ groups.all }}\" when: hostvars[item].wgrole is defined and hostvars[item].wgrole == 'master' and wireguard == True Above task will loop across all hosts, check for the wgrole defined and equal to master (with wireguard enabled), and set the wgmaster fact to the hostname.\nWe will also need to calculate the IP to use for the master and the client in a private range‚Ä¶ so let‚Äôs just get the number of item in the list for this:\n- name: Calculate IP for host set_fact: wgip: \"10.0.0.{{ lookup('ansible.utils.index_of', groups.all, 'eq', inventory_hostname) }}\" Now, each host will get a ‚Äòfact‚Äô wgip with the content similar to 10.0.0.1 that we can use to connect them.\nSo‚Ä¶ we should have all the information to create the configuration file for each client host:\n- name: Create configuration file for client copy: dest: \"/etc/wireguard/wg0.conf\" mode: 0644 content: | [Interface] ListenPort = {{ wgport }} PrivateKey = {{ ansible_local.wgprivkey.wgprivkey }} [Peer] PublicKey = {{ hostvars[wgmaster].ansible_local.wgpubkey.wgpubkey }} AllowedIPs = {{ hostvars[wgmaster].wgip }}/32 Endpoint = {{ hostvars[wgmaster].inventory_hostname }}:{{ hostvars[wgmaster].wgport }} when: wireguard == True and wgrole is defined and wgrole != 'master' In above example, check that we use hostvars with the wgmaster value we obtained, in order to fill-in the values for the master, and make use of ansible_local to grab the values that our custom facts generated.\nSo far, it has been more or less easy‚Ä¶ the problem is that in the master, we need to build a base section ([Interface]) and then, ad the client section ([Peer]) with the client‚Äôs public key and the IP of the client.\nNext, let‚Äôs check the one for the master:\n- name: Create configuration file for master copy: dest: \"/etc/wireguard/wg0.conf\" mode: 0644 content: | [Interface] ListenPort = {{ wgport }} PrivateKey = {{ hostvars[wgmaster].ansible_local.wgprivkey.wgprivkey }} {%- for item in hostvars -%} {% if hostvars[item].wgrole is defined and hostvars[item].wgrole != 'master' %} [Peer] PublicKey = {{ hostvars[item].ansible_local.wgpubkey.wgpubkey }} AllowedIPs = {{ hostvars[item].wgip }} /32 Endpoint = {{ hostvars[item].inventory_hostname }}:{{ hostvars[item].wgport }} {% endif %} {%- endfor -%} when: wireguard == True and wgrole is defined and wgrole == 'master' and item == wgmaster with_inventory_hostnames: - all More or less, the logic should be clear‚Ä¶ we iterate over all the hosts with wireguard: True and wgrole not master to add their section‚Ä¶. and this only runs on the master host, a the clients would have get the previous task instead.\nOf course, extra tasks would be needed for:\nBringing service up Open firewall ports etc. Hope you liked it!, it got me busy for some time until all pieces matched together :) Enjoy! (and if you do, you can Buy Me a Coffee ) ","wordCount":"857","inLanguage":"en","image":"https://iranzo.io/mugshot.png","datePublished":"2022-03-17T20:32:50.391Z","dateModified":"2023-08-25T09:45:44.498Z","author":{"@type":"Person","name":"Pablo Iranzo G√≥mez"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://iranzo.io/blog/2022/03/17/ansible-setup-for-vpn-using-wireguard/"},"publisher":{"@type":"Organization","name":"Pablo Iranzo G√≥mez blog","logo":{"@type":"ImageObject","url":"https://iranzo.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://iranzo.io/ accesskey=h title="Home (Alt + H)"><img src=https://iranzo.io/apple-icon-152x152.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://iranzo.io/es/ title=Spanish aria-label=Spanish>Es</a></li></ul></div></div><ul id=menu><li><a href=https://iranzo.io/ title=üè†Home><span>üè†Home</span></a></li><li><a href=https://iranzo.io/about/ title=üóíÔ∏èAbout><span>üóíÔ∏èAbout</span></a></li><li><a href=https://iranzo.io/redken_bot/ title=üêòredken_bot><span>üêòredken_bot</span></a></li><li><a href=https://iranzo.io/projects/ title=üìêProjects><span>üìêProjects</span></a></li><li><a href=https://iranzo.io/archives/ title="üóÑÔ∏è Archives"><span>üóÑÔ∏è Archives</span></a></li><li><a href=https://iranzo.io/categories/ title=üó∫Ô∏èCategories><span>üó∫Ô∏èCategories</span></a></li><li><a href=https://iranzo.io/tags/ title=üè∑Ô∏èTags><span>üè∑Ô∏èTags</span></a></li><li><a href=https://iranzo.io/search title="üîéSearch (Alt + /)" accesskey=/><span>üîéSearch</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://iranzo.io/>Home</a>&nbsp;¬ª&nbsp;<a href=https://iranzo.io/blog/>Blogs</a></div><h1 class="post-title entry-hint-parent">Ansible setup for VPN using WireGuard</h1><div class=post-description>Learn on how to setup a VPN using WireGuard using Ansible</div><div class=post-meta><span title='2022-03-17 20:32:50.391 +0000 UTC'>March 17, 2022</span>&nbsp;¬∑&nbsp;5 min&nbsp;¬∑&nbsp;Pablo Iranzo G√≥mez</div></header><div class=post-content><p>Setting up WireGuard is not a difficult process but I wanted to automate it among hosts by using a simple playbook that can be executed against the hosts and get it configured and deployed in a simple way.</p><p>I also wanted to require the minimum possible number of values in the inventory, so tried to automate lot of the information required, leaving in the end only some required values:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>wireguard</span>: <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span><span style=color:#f92672>wgrole</span>: <span style=color:#e6db74>&#39;master&#39;</span> <span style=color:#ae81ff>or &#39;something else&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>wgport</span>: <span style=color:#ae81ff>port number to use</span>
</span></span></code></pre></div><p>The first step was to create the private and public key once the <code>wireguard</code> package is installed.</p><p>This was more or less easy, just run and store the output in the folder for WireGuard.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># Create private key</span>
</span></span><span style=display:flex><span>wg genkey | tee privatekey
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Create public key</span>
</span></span><span style=display:flex><span>wg  pubkey &lt; privatekey | tee publickey
</span></span></code></pre></div><p>Later, I could set via Ansible&rsquo;s <code>set_fact</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Set WireGuard keys</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>set_fact</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>wgprivatekey</span>: <span style=color:#e6db74>&#34;{{ lookup(&#39;file&#39;, &#39;privatekey&#39;) }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>wgpublickey</span>: <span style=color:#e6db74>&#34;{{ lookup(&#39;file&#39;, &#39;publickey&#39;) }}&#34;</span>
</span></span></code></pre></div><p>But I got to the first problem&mldr; the facts are set by the host running the playbook, and for setting master/client connection I need to use the master&rsquo;s public key available on the client, and the client&rsquo;s public key on the master.</p><p>As the fact was setup at execution, other hosts couldn&rsquo;t check them via <code>hostvars</code>&mldr;</p><p>To solve this issue I went by creating a custom <code>fact</code> that is copied over the hosts, and that causes the host to refresh if something has been copied, this made the fact available in the execution:</p><p>Facts for private key:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>echo <span style=color:#e6db74>&#34;{\&#34;wgprivkey\&#34; : \&#34;</span><span style=color:#66d9ef>$(</span>cat /etc/wireguard/privatekey<span style=color:#66d9ef>)</span><span style=color:#e6db74>\&#34;}&#34;</span>
</span></span></code></pre></div><p>Fact for public key:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>echo <span style=color:#e6db74>&#34;{\&#34;wgpubkey\&#34; : \&#34;</span><span style=color:#66d9ef>$(</span>cat /etc/wireguard/publickey<span style=color:#66d9ef>)</span><span style=color:#e6db74>\&#34;}&#34;</span>
</span></span></code></pre></div><p>Note that both, provide output in a JSON compatible format.</p><p>We now need to copy the facts to the hosts and refresh the data if needed:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Create directory for ansible custom facts</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>file</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>state</span>: <span style=color:#ae81ff>directory</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>recurse</span>: <span style=color:#66d9ef>yes</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/etc/ansible/facts.d</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>register</span>: <span style=color:#ae81ff>facts_dir_created</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Copy custom facts</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>copy</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>src</span>: <span style=color:#e6db74>&#34;{{ item }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>dest</span>: <span style=color:#ae81ff>/etc/ansible/facts.d/</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>owner</span>: <span style=color:#ae81ff>root</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>group</span>: <span style=color:#ae81ff>root</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>mode</span>: <span style=color:#ae81ff>0755</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>with_fileglob</span>:
</span></span><span style=display:flex><span>    - <span style=color:#e6db74>&#34;facts/*.fact&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>register</span>: <span style=color:#ae81ff>facts_copied</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;Re-run setup to use custom facts&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>setup</span>: <span style=color:#ae81ff>~</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>when</span>: <span style=color:#ae81ff>facts_copied.changed</span>
</span></span></code></pre></div><p>Now&mldr; all hosts have the facts for private and public key so that can be used&mldr; but we need to actually create WireGuard configuration file for it&mldr; but wait&mldr; we need to know which host is the <code>master</code> that will receive all connections from the clients.</p><p>So, let&rsquo;s detect the master by the <code>wgrole</code> value:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Set wireguard master server host</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>set_fact</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>wgmaster</span>: <span style=color:#e6db74>&#34;{{ item }}&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>with_items</span>: <span style=color:#e6db74>&#34;{{ groups.all }}&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>when</span>: <span style=color:#ae81ff>hostvars[item].wgrole is defined and hostvars[item].wgrole == &#39;master&#39; and wireguard == True</span>
</span></span></code></pre></div><p>Above task will loop across all hosts, check for the <code>wgrole</code> defined and equal to <code>master</code> (with <code>wireguard</code> enabled), and set the <code>wgmaster</code> fact to the hostname.</p><p>We will also need to calculate the IP to use for the master and the client in a private range&mldr; so let&rsquo;s just get the number of item in the list for this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Calculate IP for host</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>set_fact</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>wgip</span>: <span style=color:#e6db74>&#34;10.0.0.{{ lookup(&#39;ansible.utils.index_of&#39;, groups.all, &#39;eq&#39;, inventory_hostname) }}&#34;</span>
</span></span></code></pre></div><p>Now, each host will get a &lsquo;fact&rsquo; <code>wgip</code> with the content similar to <code>10.0.0.1</code> that we can use to connect them.</p><p>So&mldr; we should have all the information to create the configuration file for each client host:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Create configuration file for client</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>copy</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>dest</span>: <span style=color:#e6db74>&#34;/etc/wireguard/wg0.conf&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>mode</span>: <span style=color:#ae81ff>0644</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>content</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      [Interface]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      ListenPort = {{ wgport }}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      PrivateKey = {{ ansible_local.wgprivkey.wgprivkey }}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      [Peer]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      PublicKey = {{ hostvars[wgmaster].ansible_local.wgpubkey.wgpubkey }}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      AllowedIPs = {{ hostvars[wgmaster].wgip }}/32
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      Endpoint = {{ hostvars[wgmaster].inventory_hostname }}:{{ hostvars[wgmaster].wgport }}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>when</span>: <span style=color:#ae81ff>wireguard == True and wgrole is defined and wgrole != &#39;master&#39;</span>
</span></span></code></pre></div><p>In above example, check that we use <code>hostvars</code> with the <code>wgmaster</code> value we obtained, in order to fill-in the values for the master, and make use of <code>ansible_local</code> to grab the values that our custom facts generated.</p><p>So far, it has been more or less easy&mldr; the problem is that in the master, we need to build a base section (<code>[Interface</code>]) and then, ad the client section (<code>[Peer]</code>) with the client&rsquo;s public key and the IP of the client.</p><p>Next, let&rsquo;s check the one for the master:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Create configuration file for master</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>copy</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>dest</span>: <span style=color:#e6db74>&#34;/etc/wireguard/wg0.conf&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>mode</span>: <span style=color:#ae81ff>0644</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>content</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      [Interface]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      ListenPort = {{ wgport }}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      PrivateKey = {{ hostvars[wgmaster].ansible_local.wgprivkey.wgprivkey }}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      {%- for item in hostvars -%}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      {% if hostvars[item].wgrole is defined and hostvars[item].wgrole != &#39;master&#39; %}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      [Peer]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      PublicKey = {{ hostvars[item].ansible_local.wgpubkey.wgpubkey }}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      AllowedIPs = {{ hostvars[item].wgip }} /32
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      Endpoint = {{ hostvars[item].inventory_hostname }}:{{ hostvars[item].wgport }}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      {% endif %}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      {%- endfor -%}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>when</span>: <span style=color:#ae81ff>wireguard == True and wgrole is defined and wgrole == &#39;master&#39; and item == wgmaster</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>with_inventory_hostnames</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>all</span>
</span></span></code></pre></div><p>More or less, the logic should be clear&mldr; we iterate over all the hosts with <code>wireguard: True</code> and <code>wgrole</code> not master to add their section&mldr;. and this only runs on the <code>master</code> host, a the clients would have get the previous task instead.</p><p>Of course, extra tasks would be needed for:</p><ul><li>Bringing service up</li><li>Open firewall ports</li><li>etc.</li></ul><p>Hope you liked it!, it got me busy for some time until all pieces matched together :)<p>Enjoy! (and if you do, you can
<a href=https://ko-fi.com/I2I4KDA0V target=_blank><img src=https://storage.ko-fi.com/cdn/brandasset/kofi_s_logo_nolabel.png height=36 style=border:0;height:36px;vertical-align:middle;display:inline-block border=0>
</img>
Buy Me a Coffee
</a>)</p></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://iranzo.io/tags/vpn/>VPN</a></li><li><a href=https://iranzo.io/tags/wireguard/>WireGuard</a></li><li><a href=https://iranzo.io/tags/ansible/>Ansible</a></li><li><a href=https://iranzo.io/tags/linux/>Linux</a></li><li><a href=https://iranzo.io/tags/automation/>Automation</a></li></ul><nav class=paginav><a class=prev href=https://iranzo.io/blog/2022/04/01/logitech-r400-remote-presentation-controller-on-linux/><span class=title>¬´ Prev</span><br><span>Logitech R400 remote presentation controller on Linux</span>
</a><a class=next href=https://iranzo.io/blog/2022/03/12/zero-touch-provisioning-openshift-for-edge-computing/><span class=title>Next ¬ª</span><br><span>Zero Touch Provisioning OpenShift for Edge computing</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Ansible setup for VPN using WireGuard on x" href="https://x.com/intent/tweet/?text=Ansible%20setup%20for%20VPN%20using%20WireGuard&amp;url=https%3a%2f%2firanzo.io%2fblog%2f2022%2f03%2f17%2fansible-setup-for-vpn-using-wireguard%2f&amp;hashtags=VPN%2cWireGuard%2cAnsible%2cLinux%2cautomation"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Ansible setup for VPN using WireGuard on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2firanzo.io%2fblog%2f2022%2f03%2f17%2fansible-setup-for-vpn-using-wireguard%2f&amp;title=Ansible%20setup%20for%20VPN%20using%20WireGuard&amp;summary=Ansible%20setup%20for%20VPN%20using%20WireGuard&amp;source=https%3a%2f%2firanzo.io%2fblog%2f2022%2f03%2f17%2fansible-setup-for-vpn-using-wireguard%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Ansible setup for VPN using WireGuard on reddit" href="https://reddit.com/submit?url=https%3a%2f%2firanzo.io%2fblog%2f2022%2f03%2f17%2fansible-setup-for-vpn-using-wireguard%2f&title=Ansible%20setup%20for%20VPN%20using%20WireGuard"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Ansible setup for VPN using WireGuard on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2firanzo.io%2fblog%2f2022%2f03%2f17%2fansible-setup-for-vpn-using-wireguard%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Ansible setup for VPN using WireGuard on whatsapp" href="https://api.whatsapp.com/send?text=Ansible%20setup%20for%20VPN%20using%20WireGuard%20-%20https%3a%2f%2firanzo.io%2fblog%2f2022%2f03%2f17%2fansible-setup-for-vpn-using-wireguard%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Ansible setup for VPN using WireGuard on telegram" href="https://telegram.me/share/url?text=Ansible%20setup%20for%20VPN%20using%20WireGuard&amp;url=https%3a%2f%2firanzo.io%2fblog%2f2022%2f03%2f17%2fansible-setup-for-vpn-using-wireguard%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Ansible setup for VPN using WireGuard on ycombinator" href="https://news.ycombinator.com/submitlink?t=Ansible%20setup%20for%20VPN%20using%20WireGuard&u=https%3a%2f%2firanzo.io%2fblog%2f2022%2f03%2f17%2fansible-setup-for-vpn-using-wireguard%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://iranzo.io/>Pablo Iranzo G√≥mez blog</a></span> ¬∑
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg></a><center><small>This blog is a participant in the Amazon Associate Program, an affiliate advertising program designed to provide a means for sites to earn advertising fees by advertising and linking to Amazon.</small></center><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>